{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        color: #333;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .stat-card h3 {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-card .value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-card .subtext {
        font-size: 0.85rem;
        color: #888;
        margin-top: 0.5rem;
    }
    
    .stat-card.green {
        border-left-color: #48bb78;
    }
    
    .stat-card.green .value {
        color: #48bb78;
    }
    
    .stat-card.orange {
        border-left-color: #ed8936;
    }
    
    .stat-card.orange .value {
        color: #ed8936;
    }
    
    .stat-card.red {
        border-left-color: #f56565;
    }
    
    .stat-card.red .value {
        color: #f56565;
    }
    
    .stat-card.purple {
        border-left-color: #9f7aea;
    }
    
    .stat-card.purple .value {
        color: #9f7aea;
    }
    
    .stat-card.teal {
        border-left-color: #38b2ac;
    }
    
    .stat-card.teal .value {
        color: #38b2ac;
    }
    
    .stat-card.pink {
        border-left-color: #ed64a6;
    }
    
    .stat-card.pink .value {
        color: #ed64a6;
    }

    .date-filter {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .filter-options {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    
    .filter-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }
    
    .filter-btn:hover {
        background: #667eea;
        color: white;
    }
    
    .filter-btn.active {
        background: #667eea;
        color: white;
    }
    
    .date-input-group {
        flex: 1;
        min-width: 200px;
    }
    
    .date-input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }
    
    .date-display {
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #667eea;
        margin-top: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .search-container {
        background: #fff;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .search-input:focus {
        border-color: #4f46e5;
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .search-result-count {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #4f46e5;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .search-tips {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #666;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #4f46e5;
    }
    
    .revenue-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .revenue-card h2 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }
    
    .revenue-card .amount {
        font-size: 2.5rem;
        font-weight: bold;
    }
    
    .table-container {
        overflow-x: auto;
        margin-bottom: 1rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    .badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        display: inline-block;
    }
    
    .badge-success { 
        background: #d1fae5; 
        color: #065f46; 
    }
    
    .badge-warning { 
        background: #fef3c7; 
        color: #92400e; 
    }
    
    .badge-danger { 
        background: #fee2e2; 
        color: #b91c1c; 
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Admin Dashboard</h1>
    <div style="font-size: 1.1rem; color: #667eea; font-weight: 600;">
        {% if date_filter == 'today' %}
            Today's Report
        {% elif date_filter == 'week' %}
            Weekly Report ({{ start_date|date:"M d" }} - {{ end_date|date:"M d, Y" }})
        {% elif date_filter == 'month' %}
            Monthly Report ({{ start_date|date:"F Y" }})
        {% elif date_filter == 'year' %}
            Yearly Report ({{ start_date|date:"Y" }})
        {% else %}
            Custom Report ({{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }})
        {% endif %}
    </div>
</div>

<!-- Date Filter Section -->
<div class="date-filter">
    <h3 style="margin-bottom: 1rem;">Filter by Date Range</h3>
    
    <form id="dateFilterForm" method="get">
        <div class="filter-options">
            <button type="button" class="filter-btn {% if date_filter == 'today' %}active{% endif %}" onclick="setDateFilter('today')">
                Today
            </button>
            <button type="button" class="filter-btn {% if date_filter == 'week' %}active{% endif %}" onclick="setDateFilter('week')">
                This Week
            </button>
            <button type="button" class="filter-btn {% if date_filter == 'month' %}active{% endif %}" onclick="setDateFilter('month')">
                This Month
            </button>
            <button type="button" class="filter-btn {% if date_filter == 'year' %}active{% endif %}" onclick="setDateFilter('year')">
                This Year
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end; margin-top: 1.5rem;">
            <div class="date-input-group">
                <label>Start Date</label>
                <input type="date" id="startDate" name="custom_start" value="{{ start_date|date:'Y-m-d' }}" class="form-control">
            </div>
            <div class="date-input-group">
                <label>End Date</label>
                <input type="date" id="endDate" name="custom_end" value="{{ end_date|date:'Y-m-d' }}" class="form-control">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">Apply Date Range</button>
            </div>
        </div>
        
        <!-- Hidden fields -->
        <input type="hidden" id="dateFilter" name="date_filter" value="{{ date_filter }}">
        <input type="hidden" name="sales_search" value="{{ sales_search|default:'' }}">
        <input type="hidden" name="stock_search" value="{{ stock_search|default:'' }}">
    </form>
    
    <div class="date-display">
        {% if date_filter == 'today' %}
            Showing data for: <strong>{{ start_date|date:"F d, Y" }}</strong>
        {% elif date_filter == 'week' %}
            Week of: <strong>{{ start_date|date:"F d" }} - {{ end_date|date:"F d, Y" }}</strong>
        {% elif date_filter == 'month' %}
            Month of: <strong>{{ start_date|date:"F Y" }}</strong>
        {% elif date_filter == 'year' %}
            Year: <strong>{{ start_date|date:"Y" }}</strong>
        {% else %}
            Custom Period: <strong>{{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}</strong>
        {% endif %}
    </div>
</div>

<!-- Statistics Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Products</h3>
        <div class="value">{{ total_products }}</div>
        <div class="subtext">Active inventory items</div>
    </div>
    
    <div class="stat-card green">
        <h3>Total Sales</h3>
        <div class="value">{{ total_sales }}</div>
        <div class="subtext">Transactions this period</div>
    </div>
    
    <div class="stat-card orange">
        <h3>Low Stock Items</h3>
        <div class="value">{{ low_stock_products }}</div>
        <div class="subtext">Need reordering</div>
    </div>
    
    <div class="stat-card red">
        <h3>Debtors</h3>
        <div class="value">{{ debtors_count }}</div>
        <div class="subtext">Outstanding balances</div>
    </div>
    
    <div class="stat-card purple">
        <h3>Cash Payments</h3>
        <div class="value">₦{{ cash_payments|floatformat:2 }}</div>
        <div class="subtext">This period</div>
    </div>
    
    <div class="stat-card teal">
        <h3>Transfer Payments</h3>
        <div class="value">₦{{ transfer_payments|floatformat:2 }}</div>
        <div class="subtext">This period</div>
    </div>
    
    <div class="stat-card pink">
        <h3>Card Payments</h3>
        <div class="value">₦{{ card_payments|floatformat:2 }}</div>
        <div class="subtext">This period</div>
    </div>

    <div class="stat-card teal">
        <h3>Today's Refunds</h3>
        <div class="value" id="todayRefunds">₦0.00</div>
        <div class="subtext">Processed today</div>
    </div>

    <div class="stat-card pink">
        <h3>Pending Refunds</h3>
        <div class="value" id="pendingRefunds">0</div>
        <div class="subtext">Awaiting approval</div>
    </div>
</div>



<!-- Total Revenue Card -->
<div class="revenue-card">
    <h2>Total Revenue ({{ date_filter|title }})</h2>
    <div class="amount">₦{{ total_revenue|floatformat:2 }}</div>
    <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
        Actual payments received
    </div>
</div>

<!-- Recent Sales Section -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Recent Sales</h2>
        <div id="salesSearchResultCount">
            {% if recent_sales|length > 0 %}
                <span class="badge" style="background:#e0e7ff; color:#3730a3;">
                    {{ recent_sales|length }} sales
                </span>
            {% endif %}
        </div>
    </div>
    
    <!-- Search Bar for Recent Sales -->
    <div class="search-container">
        <div style="position: relative;">
            <input type="text" 
                   class="search-input"
                   id="salesSearchInput"
                   placeholder="Type to search sales... (invoice, customer, staff)"
                   value="{{ sales_search|default:'' }}">
            <div id="salesSearchCount" class="search-result-count" style="display: none;"></div>
        </div>
        
        <div class="search-tips">
            <small>
                Search: Type invoice number, customer name, phone, or staff username
            </small>
        </div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Invoice</th>
                    <th>Customer</th>
                    <th>Staff</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="salesTableBody">
                {% for sale in recent_sales %}
                <tr>
                    <td><strong>{{ sale.invoice_number }}</strong></td>
                    <td>{{ sale.customer_name|default:"Walk-in" }}</td>
                    <td>{{ sale.staff.get_full_name|default:sale.staff.username }}</td>
                    <td>₦{{ sale.total|floatformat:2 }}</td>
                    <td>
                        {% if sale.payment_status == 'paid' %}
                        <span class="badge badge-success">Paid</span>
                        {% elif sale.payment_status == 'partial' %}
                        <span class="badge badge-warning">Partial</span>
                        {% else %}
                        <span class="badge badge-danger">Unpaid</span>
                        {% endif %}
                    </td>
                    <td>{{ sale.created_at|date:"M d, H:i" }}</td>
                    <td>
                        <a href="{% url 'view_receipt' sale.id %}" class="btn btn-primary btn-sm">
                            View
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem;">
                        <div class="empty-state">
                            <h3>No Sales Yet</h3>
                            <p>No sales recorded for this period</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Low Stock Alert Section -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Low Stock Alert</h2>
        <div id="stockSearchResultCount">
            {% if low_stock|length > 0 %}
                <span class="badge badge-warning">{{ low_stock|length }} items</span>
            {% endif %}
        </div>
    </div>
    
    <!-- Search Bar for Low Stock -->
    <div class="search-container">
        <div style="position: relative;">
            <input type="text" 
                   class="search-input"
                   id="stockSearchInput"
                   placeholder="Type to search low stock products... (name, SKU, category)"
                   value="{{ stock_search|default:'' }}">
            <div id="stockSearchCount" class="search-result-count" style="display: none;"></div>
        </div>
        
        <div class="search-tips">
            <small>
                Search: Type product name, SKU, or category
            </small>
        </div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>SKU</th>
                    <th>Category</th>
                    <th>Current Stock</th>
                    <th>Reorder Level</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="stockTableBody">
                {% for product in low_stock %}
                <tr>
                    <td><strong>{{ product.name }}</strong></td>
                    <td><code>{{ product.sku }}</code></td>
                    <td>{{ product.category.name|default:"N/A" }}</td>
                    <td><span class="badge badge-danger">{{ product.quantity }}</span></td>
                    <td>{{ product.reorder_level }}</td>
                    <td>
                        <a href="{% url 'edit_product' product.id %}" class="btn btn-warning btn-sm">
                            Restock
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">
                        <div class="empty-state">
                            <h3>All Products Well Stocked!</h3>
                            <p>No low stock items at this time</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Date Filter Functions
function setDateFilter(filter) {
    document.getElementById('dateFilter').value = filter;
    document.getElementById('dateFilterForm').submit();
}

let debounceTimer;

function debounceSearch(type, value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        performRealTimeSearch(type, value);
    }, 300);
}

async function performRealTimeSearch(type, searchTerm) {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const dateFilter = urlParams.get('date_filter') || '{{ date_filter }}';
        const customStart = urlParams.get('custom_start') || '{{ start_date|date:"Y-m-d" }}';
        const customEnd = urlParams.get('custom_end') || '{{ end_date|date:"Y-m-d" }}';
        
        let searchUrl = `/api/search/${type}/?q=${encodeURIComponent(searchTerm)}`;
        searchUrl += `&date_filter=${dateFilter}`;
        searchUrl += `&custom_start=${customStart}`;
        searchUrl += `&custom_end=${customEnd}`;
        
        const response = await fetch(searchUrl);
        const data = await response.json();
        
        if (data.success) {
            updateTable(type, data.results);
            updateSearchCount(type, data.count);
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}

function updateTable(type, results) {
    const tableBody = document.getElementById(type + 'TableBody');
    
    if (type === 'sales') {
        if (results.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem;">
                        <div class="empty-state">
                            <h3>No Sales Found</h3>
                            <p>No sales match your search criteria</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        let rowsHtml = '';
        results.forEach(sale => {
            let statusBadge = '';
            if (sale.payment_status === 'paid') {
                statusBadge = '<span class="badge badge-success">Paid</span>';
            } else if (sale.payment_status === 'partial') {
                statusBadge = '<span class="badge badge-warning">Partial</span>';
            } else {
                statusBadge = '<span class="badge badge-danger">Unpaid</span>';
            }
            
            const date = new Date(sale.created_at);
            const formattedDate = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            rowsHtml += `
                <tr>
                    <td><strong>${sale.invoice_number}</strong></td>
                    <td>${sale.customer_name || 'Walk-in'}</td>
                    <td>${sale.staff_name}</td>
                    <td>₦${parseFloat(sale.total).toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <a href="/receipt/${sale.id}/" class="btn btn-primary btn-sm">
                            View
                        </a>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = rowsHtml;
        
    } else if (type === 'stock') {
        if (results.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">
                        <div class="empty-state">
                            <h3>No Low Stock Items</h3>
                            <p>No products match your search</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        let rowsHtml = '';
        results.forEach(product => {
            rowsHtml += `
                <tr>
                    <td><strong>${product.name}</strong></td>
                    <td><code>${product.sku}</code></td>
                    <td>${product.category || 'N/A'}</td>
                    <td><span class="badge badge-danger">${product.quantity}</span></td>
                    <td>${product.reorder_level}</td>
                    <td>
                        <a href="/products/edit/${product.id}/" class="btn btn-warning btn-sm">
                            Restock
                        </a>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = rowsHtml;
    }
}

function updateSearchCount(type, count) {
    const countElement = document.getElementById(type + 'SearchCount');
    const resultCountElement = document.getElementById(type + 'SearchResultCount');
    
    if (countElement) {
        if (count > 0) {
            countElement.innerHTML = `<small>${count} found</small>`;
            countElement.style.display = 'block';
        } else {
            countElement.style.display = 'none';
        }
    }
    
    if (resultCountElement) {
        if (count > 0) {
            resultCountElement.innerHTML = `<span class="badge" style="background:#e0e7ff; color:#3730a3;">${count} results</span>`;
        } else {
            resultCountElement.innerHTML = '<span class="badge badge-warning">No results</span>';
        }
    }
}

async function loadRefundStats() {
    try {
        const response = await fetch('/api/refund-stats/');
        const data = await response.json();
        
        document.getElementById('todayRefunds').textContent = `₦${data.today_refunds.toFixed(2)}`;
        document.getElementById('pendingRefunds').textContent = data.pending_requests;
    } catch (error) {
        console.error('Error loading refund stats:', error);
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRefundStats();
});


document.addEventListener('DOMContentLoaded', function() {
    // Get the unread count from data attribute
    const unreadCount = parseInt(document.body.dataset.unreadDashboardCount || '0');
    
    if (unreadCount > 0) {
        fetch('/mark-notifications-read/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                notification_type: 'dashboard'
            })
        });
    }
});
// Initialize search inputs
document.addEventListener('DOMContentLoaded', function() {
    const salesSearchInput = document.getElementById('salesSearchInput');
    const stockSearchInput = document.getElementById('stockSearchInput');
    
    if (salesSearchInput) {
        salesSearchInput.addEventListener('input', function(e) {
            debounceSearch('sales', this.value);
        });
        
        salesSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                debounceSearch('sales', '');
            }
        });
    }
    
    if (stockSearchInput) {
        stockSearchInput.addEventListener('input', function(e) {
            debounceSearch('stock', this.value);
        });
        
        stockSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                debounceSearch('stock', '');
            }
        });
    }
});
</script>
{% endblock %}