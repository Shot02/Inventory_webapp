{% extends 'base.html' %}

{% block title %}Staff Management{% endblock %}

{% block content %}
<style>
    /* Table Styles */
    .staff-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    .staff-table th,
    .staff-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .staff-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
        position: sticky;
        top: 0;
    }
    
    .staff-table tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Badge Styles */
    .status-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-inactive {
        background: #fee2e2;
        color: #b91c1c;
    }
    
    .role-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .role-admin {
        background: #818cf8;
        color: white;
    }
    
    .role-staff {
        background: #34d399;
        color: white;
    }
    
    .role-manager {
        background: #f59e0b;
        color: white;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .action-buttons .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
    
    /* Search Container */
    .search-container {
        background: #fff;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }
    
    .search-input-group {
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        padding-right: 120px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .search-input:focus {
        border-color: #4f46e5;
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .search-result-count {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #4f46e5;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        display: none;
    }
    
    .search-tips {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #666;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #4f46e5;
    }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
    }
    
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 500px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        line-height: 1;
    }
    
    .modal-close:hover {
        color: #333;
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        margin-bottom: 0.5rem;
    }
    
    .checkbox-label input[type="checkbox"] {
        width: auto;
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
    }
    
    .form-actions .btn {
        flex: 1;
    }
    
    /* Toast Notification */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
        color: white;
        font-weight: 500;
    }
    
    .toast-success { background: #48bb78; }
    .toast-error { background: #f56565; }
    .toast-info { background: #667eea; }
    .toast-warning { background: #ed8936; }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Staff Management</h1>
    <a href="{% url 'register_staff' %}" class="btn btn-primary">Add New Staff</a>
</div>

<!-- Search Bar -->
<div class="search-container">
    <div class="search-input-group">
        <input type="text" 
               class="search-input"
               id="staffSearchInput"
               placeholder="Type to search staff... (name, username, email, phone, role)"
               value="{{ search_query|default:'' }}"
               autofocus>
        <div id="staffSearchCount" class="search-result-count"></div>
    </div>
    
    <div class="search-tips">
        <small>
            <strong>Search Tips:</strong> Type username, name, email, phone, or role. Press Enter to search or Escape to clear.
        </small>
    </div>
</div>

<div class="card">
    <div style="overflow-x: auto;">
        <table class="staff-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Date Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="staffTableBody">
                {% for staff_member in staff %}
                <tr data-staff-id="{{ staff_member.id }}"
                    data-username="{{ staff_member.username }}"
                    data-first-name="{{ staff_member.first_name|default:'' }}"
                    data-last-name="{{ staff_member.last_name|default:'' }}"
                    data-email="{{ staff_member.email|default:'' }}"
                    data-phone="{{ staff_member.phone|default:'' }}"
                    data-role="{{ staff_member.role }}"
                    data-is-active="{{ staff_member.is_active }}">
                    <td><strong>{{ staff_member.username }}</strong></td>
                    <td>
                        {% if staff_member.first_name or staff_member.last_name %}
                            {{ staff_member.first_name }} {{ staff_member.last_name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ staff_member.email|default:"-" }}</td>
                    <td>{{ staff_member.phone|default:"-" }}</td>
                    <td>
                        <span class="role-badge role-{{ staff_member.role }}">
                            {{ staff_member.role|title }}
                        </span>
                    </td>
                    <td>
                        {% if staff_member.is_active %}
                        <span class="status-badge status-active">Active</span>
                        {% else %}
                        <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ staff_member.date_joined|date:"M d, Y" }}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="openEditStaffModal({{ staff_member.id }})" 
                                    class="btn btn-primary btn-sm"
                                    title="Edit staff member">
                                Edit
                            </button>
                            {% if staff_member != request.user %}
                            <button onclick="confirmDeleteStaff({{ staff_member.id }}, '{{ staff_member.username|escapejs }}')" 
                                    class="btn btn-danger btn-sm"
                                    title="Delete staff member">
                                Delete
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ‘¥</div>
                            <h3>No Staff Members Found</h3>
                            <p>Get started by adding your first staff member.</p>
                            <a href="{% url 'register_staff' %}" class="btn btn-primary mt-2">
                                Add Staff Member
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Staff Modal -->
<div id="editStaffModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin: 0;">Edit Staff Member</h3>
            <button onclick="closeEditStaffModal()" class="modal-close">&times;</button>
        </div>
        
        <form id="editStaffForm">
            {% csrf_token %}
            <input type="hidden" id="editStaffId" name="user_id">
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="editStaffUsername">Username *</label>
                    <input type="text" id="editStaffUsername" name="username" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editStaffEmail">Email *</label>
                    <input type="email" id="editStaffEmail" name="email" class="form-control" required>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="editStaffFirstName">First Name</label>
                    <input type="text" id="editStaffFirstName" name="first_name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="editStaffLastName">Last Name</label>
                    <input type="text" id="editStaffLastName" name="last_name" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label for="editStaffPhone">Phone</label>
                <input type="tel" id="editStaffPhone" name="phone" class="form-control">
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="editStaffRole">Role *</label>
                    <select id="editStaffRole" name="role" class="form-control" required>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editStaffPassword">New Password</label>
                    <input type="password" id="editStaffPassword" name="password" class="form-control" 
                           placeholder="Leave blank to keep current">
                    <small style="color: #666; font-size: 0.85rem;">
                        Optional: Only enter if you want to change the password
                    </small>
                </div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="editStaffIsActive" name="is_active" value="true">
                    <span>Active Account</span>
                </label>
                <small style="display: block; margin-top: 0.25rem; color: #666; font-size: 0.85rem;">
                    Uncheck to deactivate this account
                </small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-success" id="editStaffSubmitBtn">
                    Save Changes
                </button>
                <button type="button" onclick="closeEditStaffModal()" class="btn btn-danger">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin: 0;">Confirm Delete</h3>
            <button onclick="closeDeleteModal()" class="modal-close">&times;</button>
        </div>
        
        <div id="deleteConfirmMessage" style="margin: 1.5rem 0;">
            <!-- Message will be inserted here -->
        </div>
        
        <div class="form-actions">
            <button type="button" onclick="deleteStaffMember()" class="btn btn-danger" id="deleteConfirmBtn">
                Delete
            </button>
            <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
// Global variables
let currentStaffIdToDelete = null;
let currentStaffNameToDelete = null;

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Open edit staff modal
function openEditStaffModal(staffId) {
    try {
        const row = document.querySelector(`tr[data-staff-id="${staffId}"]`);
        if (!row) {
            showToast('Staff member not found', 'error');
            return;
        }
        
        const staffData = {
            id: row.dataset.staffId,
            username: row.dataset.username,
            firstName: row.dataset.firstName || '',
            lastName: row.dataset.lastName || '',
            email: row.dataset.email,
            phone: row.dataset.phone || '',
            role: row.dataset.role,
            isActive: row.dataset.isActive === 'true'
        };
        
        // Populate form fields
        document.getElementById('editStaffId').value = staffData.id;
        document.getElementById('editStaffUsername').value = staffData.username;
        document.getElementById('editStaffFirstName').value = staffData.firstName;
        document.getElementById('editStaffLastName').value = staffData.lastName;
        document.getElementById('editStaffEmail').value = staffData.email;
        document.getElementById('editStaffPhone').value = staffData.phone;
        document.getElementById('editStaffRole').value = staffData.role;
        document.getElementById('editStaffIsActive').checked = staffData.isActive;
        document.getElementById('editStaffPassword').value = '';
        
        // Show modal
        document.getElementById('editStaffModal').style.display = 'flex';
        document.getElementById('editStaffUsername').focus();
        
    } catch (error) {
        console.error('Error opening edit modal:', error);
        showToast('Error loading staff data', 'error');
    }
}

// Close edit staff modal
function closeEditStaffModal() {
    document.getElementById('editStaffModal').style.display = 'none';
    document.getElementById('editStaffForm').reset();
    
    // Reset submit button
    const submitBtn = document.getElementById('editStaffSubmitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Save Changes';
    submitBtn.style.background = '';
}

// Handle edit staff form submission
document.getElementById('editStaffForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('editStaffSubmitBtn');
    const formData = new FormData(this);
    
    // Ensure is_active is properly set
    const isActiveCheckbox = document.getElementById('editStaffIsActive');
    if (!isActiveCheckbox.checked) {
        formData.set('is_active', 'false');
    }
    
    // Basic validation
    const username = document.getElementById('editStaffUsername').value.trim();
    const email = document.getElementById('editStaffEmail').value.trim();
    const role = document.getElementById('editStaffRole').value;
    
    // Reset border colors
    document.querySelectorAll('#editStaffForm .form-control').forEach(input => {
        input.style.borderColor = '#e0e0e0';
    });
    
    let isValid = true;
    
    if (!username) {
        document.getElementById('editStaffUsername').focus();
        document.getElementById('editStaffUsername').style.borderColor = '#f56565';
        isValid = false;
    }
    
    if (!email) {
        if (isValid) document.getElementById('editStaffEmail').focus();
        document.getElementById('editStaffEmail').style.borderColor = '#f56565';
        isValid = false;
    } else {
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            if (isValid) document.getElementById('editStaffEmail').focus();
            document.getElementById('editStaffEmail').style.borderColor = '#f56565';
            isValid = false;
        }
    }
    
    if (!role) {
        document.getElementById('editStaffRole').style.borderColor = '#f56565';
        isValid = false;
    }
    
    if (!isValid) {
        showToast('Please fill in all required fields correctly', 'error');
        return;
    }
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Saving...';
        
        const response = await fetch('/staff/edit/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            submitBtn.innerHTML = 'âœ“ Saved!';
            submitBtn.style.background = '#10b981';
            
            showToast('Staff member updated successfully!', 'success');
            
            setTimeout(() => {
                closeEditStaffModal();
                location.reload();
            }, 1500);
            
        } else {
            showToast(result.error || 'Error updating staff member', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Save Changes';
        }
        
    } catch (error) {
        console.error('Network error:', error);
        showToast('Network error. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Save Changes';
    }
});

// Delete staff confirmation
function confirmDeleteStaff(staffId, username) {
    currentStaffIdToDelete = staffId;
    currentStaffNameToDelete = username;
    
    const message = `
        <p>Are you sure you want to delete staff member <strong>"${username}"</strong>?</p>
        <p style="color: #f56565; margin-top: 1rem;">
            <strong>Warning:</strong> This action cannot be undone. All data associated with this staff member will be permanently deleted.
        </p>
    `;
    
    document.getElementById('deleteConfirmMessage').innerHTML = message;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
}

// Close delete modal
function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    currentStaffIdToDelete = null;
    currentStaffNameToDelete = null;
}

// Delete staff member
async function deleteStaffMember() {
    if (!currentStaffIdToDelete) return;
    
    const deleteBtn = document.getElementById('deleteConfirmBtn');
    const staffId = currentStaffIdToDelete;
    
    try {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = 'Deleting...';
        
        const response = await fetch(`/staff/delete/${staffId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Staff member deleted successfully!', 'success');
            closeDeleteModal();
            
            // Remove the row from the table
            const row = document.querySelector(`tr[data-staff-id="${staffId}"]`);
            if (row) {
                row.style.opacity = '0.5';
                row.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    row.remove();
                    
                    // Check if table is empty
                    const tableBody = document.getElementById('staffTableBody');
                    if (tableBody.children.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">ðŸ‘¥</div>
                                        <h3>No Staff Members Found</h3>
                                        <p>Get started by adding your first staff member.</p>
                                        <a href="{% url 'register_staff' %}" class="btn btn-primary mt-2">
                                            Add Staff Member
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                }, 300);
            } else {
                // If row not found, reload the page
                setTimeout(() => location.reload(), 500);
            }
            
        } else {
            showToast(result.error || 'Failed to delete staff member', 'error');
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = 'Delete';
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        showToast('Network error. Please try again.', 'error');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = 'Delete';
    }
}

// Real-time search for staff
let staffDebounceTimer;

function debounceStaffSearch() {
    clearTimeout(staffDebounceTimer);
    staffDebounceTimer = setTimeout(() => {
        performStaffSearch();
    }, 300);
}

function performStaffSearch() {
    const searchTerm = document.getElementById('staffSearchInput').value.trim();
    const searchCount = document.getElementById('staffSearchCount');
    
    if (!searchTerm) {
        // Show all rows
        document.querySelectorAll('#staffTableBody tr[data-staff-id]').forEach(row => {
            row.style.display = '';
        });
        searchCount.style.display = 'none';
        return;
    }
    
    const searchLower = searchTerm.toLowerCase();
    const rows = document.querySelectorAll('#staffTableBody tr[data-staff-id]');
    let foundCount = 0;
    
    rows.forEach(row => {
        const username = (row.dataset.username || '').toLowerCase();
        const firstName = (row.dataset.firstName || '').toLowerCase();
        const lastName = (row.dataset.lastName || '').toLowerCase();
        const email = (row.dataset.email || '').toLowerCase();
        const phone = (row.dataset.phone || '').toLowerCase();
        const role = (row.dataset.role || '').toLowerCase();
        
        const fullName = `${firstName} ${lastName}`.toLowerCase();
        
        if (username.includes(searchLower) || 
            fullName.includes(searchLower) || 
            email.includes(searchLower) || 
            phone.includes(searchLower) ||
            role.includes(searchLower)) {
            row.style.display = '';
            foundCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update search count
    if (foundCount > 0) {
        searchCount.textContent = `${foundCount} found`;
        searchCount.style.display = 'block';
    } else {
        searchCount.style.display = 'none';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('staffSearchInput');
    
    if (searchInput) {
        searchInput.addEventListener('input', debounceStaffSearch);
        
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                debounceStaffSearch();
            }
        });
        
        // Focus search input
        searchInput.focus();
        
        // Check for search query in URL
        const urlParams = new URLSearchParams(window.location.search);
        const searchParam = urlParams.get('search');
        if (searchParam) {
            searchInput.value = searchParam;
            setTimeout(() => performStaffSearch(), 100);
        }
    }
});
</script>
{% endblock %}