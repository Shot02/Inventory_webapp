{% extends 'base.html' %}

{% block title %}{{ action }} Product{% endblock %}

{% block content %}
<h1>{{ action }} Product</h1>

<div class="card">
    <form method="post" enctype="multipart/form-data" id="productForm">
        {% csrf_token %}
        
        {% if form.errors %}
        <div class="alert alert-error" style="margin-bottom: 1rem;">
            <strong>Please fix the following errors:</strong>
            <ul style="margin: 0.5rem 0 0 1rem;">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>{{ field|title }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <div class="form-group">
            <label>Product Name *</label>
            <input type="text" name="name" class="form-control" 
                   value="{{ form.name.value|default:'' }}" required>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
                <label>Category</label>
                <select name="category" class="form-control" id="categorySelect">
                    <option value="">-- Select Category --</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" 
                            {% if form.category.value == category.id|stringformat:"i" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
                <div style="margin-top: 0.5rem;">
                    <input type="text" name="new_category" class="form-control" 
                           placeholder="Or enter new category name" id="newCategoryInput">
                </div>
            </div>
            
            <div class="form-group">
                <label>Supplier</label>
                <select name="supplier" class="form-control" id="supplierSelect">
                    <option value="">-- Select Supplier --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" 
                            {% if form.supplier.value == supplier.id|stringformat:"i" %}selected{% endif %}>
                        {{ supplier.name }}
                    </option>
                    {% endfor %}
                </select>
                <div style="margin-top: 0.5rem;">
                    <input type="text" name="new_supplier" class="form-control" 
                           placeholder="Or enter new supplier name" id="newSupplierInput">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Description</label>
            <textarea name="description" class="form-control" rows="3">{{ form.description.value|default:'' }}</textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label>Selling Price (₦) *</label>
                <input type="number" name="price" class="form-control" 
                       step="0.01" min="0" 
                       value="{{ form.price.value|default:'' }}" required>
            </div>
            
            <div class="form-group">
                <label>Cost Price (₦)</label>
                <input type="number" name="cost_price" class="form-control" 
                       step="0.01" min="0" 
                       value="{{ form.cost_price.value|default:0 }}">
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label>Quantity *</label>
                <input type="number" name="quantity" class="form-control" 
                       min="0" 
                       value="{{ form.quantity.value|default:0 }}" required>
            </div>
            
            <div class="form-group">
                <label>Reorder Level</label>
                <input type="number" name="reorder_level" class="form-control" 
                       min="0" 
                       value="{{ form.reorder_level.value|default:10 }}">
            </div>
        </div>
        
        <div class="form-group">
            <label>Product Image</label>
            <input type="file" name="image" class="form-control" 
                   accept="image/*">
            {% if product and product.image %}
            <div style="margin-top: 0.5rem;">
                <p>Current Image:</p>
                <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                     style="max-width: 150px; max-height: 150px; border-radius: 8px;">
                <label style="display: block; margin-top: 0.5rem;">
                    <input type="checkbox" name="clear_image"> Remove current image
                </label>
            </div>
            {% endif %}
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-success" id="submitBtn">Save Product</button>
            <a href="{% url 'product_list' %}" class="btn btn-danger">Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('productForm');
    const submitBtn = document.getElementById('submitBtn');
    const nameInput = form.querySelector('input[name="name"]');
    const priceInput = form.querySelector('input[name="price"]');
    const quantityInput = form.querySelector('input[name="quantity"]');
    const categorySelect = document.getElementById('categorySelect');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const supplierSelect = document.getElementById('supplierSelect');
    const newSupplierInput = document.getElementById('newSupplierInput');
    
    // Set focus on product name
    nameInput.focus();
    
    // Handle category selection logic
    categorySelect.addEventListener('change', function() {
        if (this.value) {
            newCategoryInput.value = '';
        }
    });
    
    newCategoryInput.addEventListener('input', function() {
        if (this.value) {
            categorySelect.value = '';
        }
    });
    
    // Handle supplier selection logic
    supplierSelect.addEventListener('change', function() {
        if (this.value) {
            newSupplierInput.value = '';
        }
    });
    
    newSupplierInput.addEventListener('input', function() {
        if (this.value) {
            supplierSelect.value = '';
        }
    });
    
    // Validate form
    form.addEventListener('submit', function(e) {
        const name = nameInput.value.trim();
        const price = parseFloat(priceInput.value) || 0;
        const quantity = parseInt(quantityInput.value) || 0;
        
        if (!name) {
            e.preventDefault();
            nameInput.focus();
            return;
        }
        
        if (price <= 0) {
            e.preventDefault();
            priceInput.focus();
            return;
        }
        
        if (quantity < 0) {
            e.preventDefault();
            quantityInput.focus();
            return;
        }
        
        // Check if either category or new category is provided
        if (!categorySelect.value && !newCategoryInput.value.trim()) {
            e.preventDefault();
            return;
        }
        
        // Disable button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Saving...';
    });
});
</script>
{% endblock %}