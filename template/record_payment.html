{% extends 'base.html' %}

{% block title %}Record Payment{% endblock %}

{% block content %}
<h1>Record Payment for Invoice {{ sale.invoice_number }}</h1>

<div class="card" style="max-width: 600px; margin: 0 auto;">
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p><strong>Customer:</strong> {{ sale.customer_name|default:"Walk-in" }}</p>
        <p><strong>Total Amount:</strong> ₦{{ sale.total|floatformat:2 }}</p>
        <p><strong>Amount Paid:</strong> ₦{{ sale.amount_paid|floatformat:2 }}</p>
        <p><strong style="color: #dc3545;">Outstanding Balance:</strong> 
           <strong style="font-size: 1.3rem;">₦{{ sale.balance|floatformat:2 }}</strong>
        </p>
    </div>
    
    <form method="post" id="paymentForm">
        {% csrf_token %}
        
        <div class="form-group">
            <label>Payment Amount *</label>
            <div style="position: relative;">
                <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666;">₦</span>
                <input type="number" name="amount" class="form-control" 
                       style="padding-left: 30px;"
                       step="0.01" min="0.01" max="{{ sale.balance|floatformat:2 }}" 
                       placeholder="Enter payment amount" required
                       id="paymentAmount">
            </div>
            <small style="color: #666;">Maximum: ₦{{ sale.balance|floatformat:2 }}</small>
            <small id="amountError" style="color: #dc3545; display: none;"></small>
        </div>
        
        <div class="form-group">
            <label>Payment Method *</label>
            <select name="payment_method" class="form-control" required style="height: 45px;">
                <option value="cash" selected>Cash</option>
                <option value="transfer">Bank Transfer</option>
                <option value="card">Card</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Reference Number (Optional)</label>
            <input type="text" name="reference" class="form-control" 
                   placeholder="Enter reference number if any"
                   style="height: 45px;">
        </div>
        
        <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea name="notes" class="form-control" rows="3" 
                      placeholder="Optional notes about this payment"
                      style="resize: vertical;"></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-success" id="submitBtn" style="flex: 1; height: 45px; font-size: 1.1rem;">
                Record Payment
            </button>
            <a href="{% url 'debtors_list' %}" class="btn btn-danger" style="height: 45px; padding: 0 1.5rem;">
                Cancel
            </a>
        </div>
    </form>
</div>

<style>
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-control {
        height: 45px;
        font-size: 1rem;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 0.25rem;
        display: none;
    }
    
    .input-error {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('paymentForm');
    const submitBtn = document.getElementById('submitBtn');
    const amountInput = document.getElementById('paymentAmount');
    const amountError = document.getElementById('amountError');
    const maxAmount = parseFloat('{{ sale.balance }}');
    
    // Set focus on amount input
    amountInput.focus();
    
    // Set max value attribute
    amountInput.max = maxAmount.toFixed(2);
    
    // Real-time validation
    amountInput.addEventListener('input', function() {
        const enteredAmount = parseFloat(this.value) || 0;
        
        // Clear any previous error
        amountError.style.display = 'none';
        amountInput.classList.remove('input-error');
        
        // Validate amount
        if (enteredAmount <= 0) {
            showError('Please enter a payment amount greater than 0');
            submitBtn.disabled = true;
        } else if (enteredAmount > maxAmount) {
            showError(`Payment amount cannot exceed ₦${maxAmount.toFixed(2)}`);
            submitBtn.disabled = true;
        } else {
            submitBtn.disabled = false;
        }
    });
    
    // Show inline error
    function showError(message) {
        amountError.textContent = message;
        amountError.style.display = 'block';
        amountInput.classList.add('input-error');
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const amount = parseFloat(amountInput.value) || 0;
        
        // Clear any previous error
        amountError.style.display = 'none';
        amountInput.classList.remove('input-error');
        
        // Validate amount
        if (amount <= 0) {
            e.preventDefault();
            showError('Please enter a payment amount greater than 0');
            amountInput.focus();
            return;
        }
        
        if (amount > maxAmount) {
            e.preventDefault();
            showError(`Payment amount cannot exceed ₦${maxAmount.toFixed(2)}`);
            amountInput.focus();
            return;
        }
        
        // Disable button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
        
    });
});
</script>
{% endblock %}