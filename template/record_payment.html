{% extends 'base.html' %}

{% block title %}Record Payment{% endblock %}

{% block content %}
<h1> Record Payment for Invoice {{ sale.invoice_number }}</h1>

<div class="card">
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p><strong>Customer:</strong> {{ sale.customer_name|default:"Walk-in" }}</p>
        <p><strong>Total Amount:</strong> ₦{{ sale.total|floatformat:2 }}</p>
        <p><strong>Amount Paid:</strong> ₦{{ sale.amount_paid|floatformat:2 }}</p>
        <p><strong style="color: #dc3545;">Outstanding Balance:</strong> 
           <strong style="font-size: 1.3rem;">₦{{ sale.balance|floatformat:2 }}</strong>
        </p>
    </div>
    
    <form method="post" id="paymentForm">
        {% csrf_token %}
        
        <div class="form-group">
            <label>Payment Amount *</label>
            {{ form.amount }}
            <small style="color: #666;">Maximum: ₦{{ sale.balance|floatformat:2 }}</small>
        </div>
        
        <div class="form-group">
            <label>Payment Method *</label>
            {{ form.payment_method }}
        </div>
        
        <div class="form-group">
            <label>Reference Number</label>
            {{ form.reference }}
        </div>
        
        <div class="form-group">
            <label>Notes</label>
            {{ form.notes }}
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-success" id="submitBtn"> Record Payment</button>
            <a href="{% url 'debtors_list' %}" class="btn btn-danger"> Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set max amount for payment
    const amountInput = document.querySelector('#id_amount');
    if (amountInput) {
        amountInput.setAttribute('max', '{{ sale.balance }}');
        amountInput.setAttribute('step', '0.01');
    }
    
    // Handle form submission
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Processing...';
        
        const formData = new FormData(this);
        
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to debtors list on success
                window.location.href = "{% url 'debtors_list' %}";
            } else {
                console.log('Error: ' + data.error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Record Payment';
            }
        })
        .catch(error => {
            console.log('Error processing payment: ' + error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Record Payment';
        });
    });
});
</script>
{% endblock %}