{% extends 'base.html' %}

{% block title %}{{ saved_cart.cart_name }}{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>{{ saved_cart.cart_name }}</h1>
        <div>
            <button onclick="loadSavedCart({{ saved_cart.id }})" class="btn btn-success">
                Load in POS
            </button>
            <a href="{% url 'saved_carts_list' %}" class="btn btn-primary">
                Back to List
            </a>
        </div>
    </div>
    
    <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
            <h3>Cart Details</h3>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <strong>Customer Name:</strong> {{ cart_data.customer_name|default:"Not specified" }}
                </div>
                <div>
                    <strong>Customer Phone:</strong> {{ cart_data.customer_phone|default:"Not specified" }}
                </div>
                <div>
                    <strong>Payment Type:</strong> {{ cart_data.payment_type|default:"full"|title }}
                </div>
                <div>
                    <strong>Payment Method:</strong> {{ cart_data.payment_method|default:"cash"|title }}
                </div>
                <div>
                    <strong>Amount Paid:</strong> ₦{{ cart_data.amount_paid|default:"0.00"|floatformat:2 }}
                </div>
                <div>
                    <strong>Saved On:</strong> {{ saved_cart.created_at|date:"M d, Y H:i" }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3>Cart Items ({{ items_count }})</h3>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Discount</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if cart_data.items %}
                        {% for item in cart_data.items %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>₦{{ item.price|floatformat:2 }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>₦{{ item.discount|default:"0.00"|floatformat:2 }}</td>
                            <td><strong>₦{{ item.total|default:item.price|floatformat:2 }}</strong></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">
                                <p style="color: #999;">No items in this cart</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        {% if cart_data.items %}
        <div style="background: #f8f9fa; padding: 1.5rem; border-top: 2px solid #e9ecef;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 1.2rem;">
                    <strong>Cart Total:</strong>
                </div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
                    ₦{{ total_amount|floatformat:2 }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button onclick="loadSavedCart({{ saved_cart.id }})" class="btn btn-success" style="flex: 1;">
            Load This Cart in POS
        </button>
        <button onclick="deleteSavedCart({{ saved_cart.id }}, '{{ saved_cart.cart_name|escapejs }}')" class="btn btn-danger">
            Delete This Cart
        </button>
    </div>
</div>

<script>
async function loadSavedCart(cartId) {
    try {
        const response = await fetch(`/api/load-saved-cart/${cartId}/`);
        const data = await response.json();
        
        if (data.success) {
            // Store cart data in sessionStorage for POS page to load
            sessionStorage.setItem('cartToLoad', JSON.stringify({
                name: data.cart_name,
                data: data.cart_data,
                saved_cart_id: cartId
            }));
            
            // Show success message
            alert(`Cart "${data.cart_name}" loaded successfully! Redirecting to POS...`);
            
            // Redirect to POS
            window.location.href = "{% url 'home' %}";
        } else {
            alert('Failed to load cart: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Load cart error:', error);
        alert('Failed to load cart. Please check your connection.');
    }
}

async function deleteSavedCart(cartId, cartName) {
    if (confirm(`Are you sure you want to delete "${cartName}"?`)) {
        try {
            const response = await fetch(`/api/delete-saved-cart/${cartId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Cart deleted successfully!');
                window.location.href = "{% url 'saved_carts_list' %}";
            } else {
                alert('Failed to delete cart: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Delete cart error:', error);
            alert('Failed to delete cart. Please check your connection.');
        }
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}